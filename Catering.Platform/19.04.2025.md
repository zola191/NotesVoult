Tenant - это комплексное термин для клиента данного проекта

Используется 3 подхода
1.  Общая схема и общая база данных для всех пользователей (tenantId) Shared database и Separated Scheme, как правило, начинают с данной схемы после переходят ко второму типу
## Плюсы
- не требуется динамическое конструирования ConntectionString
## Минусы
- Дороже масштабировать, потребуется использовать Sharding 
	для примера 10 tenant
	8 Достаточно мощностей
	2 недостаточно из-за объема
- Сложность написания кода, сложная схема БД, могут дублироваться таблицы
2. Общая база с делением схем (промежуточный шаг к схеме 3) крайне редкая схема в проде 
3. Для каждого tenant своя БД (business to busines), системы ориентированы на конкретного клиента, например рынок застройщиков
## Плюсы
- легко масштабируется
## Минусы
- менять ConnectionString

#вопросы Горизонтальное и вертикальное масштабирование

#проект mapping в handler если CQRS или в сервисах если сервисный подход

# Exception

Контролируемые 
1. Ошибка валидации
дополнить
и не контролируемые 
1. Падение системы OutOfMemoryException, системная ошибка сервера, crash runtime без возможности user frendly ответа все равно что отключить сервер
дополнить

Правильная обработка ошибок позволяет обезопасить приложения от взлома
ASP механизмы обработки ошибки
1. try catch

ASP Core из коробки IsDevelopment, Release
```csharp
//Страница ошибок
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}
```
для прода это не используется

UseExceptionHandler позволяет сделать redirect на указанный route характерно для Razor приложения

2. Самописный обработчик Middleware

```csharp
public class ErrorHandlingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<ErrorHandlingMiddleware> _logger;

    public ErrorHandlingMiddleware(RequestDelegate next, ILogger<ErrorHandlingMiddleware> logger)
    {
        _next = next; // ссылка на след. делегат
        _logger = logger; // логирование никогда не бывает лишним, но не стоит логировать чувствительные данные (узнать у тех. лида по проекту, что можно логировать, а что нет?)
    }

    public async Task Invoke(HttpContext context)
    {
        try
        {
            await _next(context);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Unhandled exception");
            context.Response.StatusCode = 500;
            context.Response.ContentType = "application/json";
            await context.Response.WriteAsync(JsonSerializer.Serialize(new
            {
                error = "Произошла внутренняя ошибка сервера"
            }));
        }
    }
}
```

способ регистрации самописного middleware
```csharp
app.UseMiddleware<ErrorHandlingMiddleware>();
```

3. Фильтры исключений Exception Filters (точечная обработка например обработка только одной ошибки только в одном контроллере которого нигде нет больше)

Exception Filters рекомендуется использовать до того как уйдет ошибка в Middleware

Exception Filters унаследована от ASP MVC

```csharp
public class GlobalExceptionFilter : IExceptionFilter
{
    private readonly ILogger<GlobalExceptionFilter> _logger;

    public GlobalExceptionFilter(ILogger<GlobalExceptionFilter> logger)
    {
        _logger = logger;
    }

    public void OnException(ExceptionContext context)
    {
        _logger.LogError(context.Exception, "Exception caught in filter");

        context.Result = new ObjectResult(new { error = "Что-то пошло не так" })
        {
            StatusCode = 500
        };
    }
}
```


```csharp
services.AddControllers(options =>
{
    options.Filters.Add<GlobalExceptionFilter>();
});
```

Middleware > Exception Filters для глобальных Exception

### способы показывания информация об ошибке

1. UseStatusCodePages (используется для временных стабов, сложно сделать что то user frendly, актуально для создания "заглушок")

```csharp
app.UseStatusCodePages(async statusCodeContext =>
{
    var response = statusCodeContext.HttpContext.Response;
    response.ContentType = "text/plain";
    
    await response.WriteAsync(
        $"Статусный код ошибки: {response.StatusCode}");
});
```

2.  app.UseStatusCodePagesWithRedirects("/Error/{0}"); redirect на специфичную страницу Error Page, актуально для Razor, в web api не используют

Problem Deatails способ предоставления информации об ошибке в формате JSON характерно для WEB API

TraceID агрегировать данные и построить цепочку выполнения