# üß™ Unit –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ .NET

> [!summary] **Unit —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –∏–ª–∏ –º–µ—Ç–æ–¥–æ–≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.  
–¶–µ–ª—å: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ –∏–∑–æ–ª—è—Ü–∏–∏.

---

## üîß –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏:
| –§—Ä–µ–π–º–≤–æ—Ä–∫ | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ |
|-----------|-------------|
| **xUnit** | –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π, –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è, —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω Microsoft |
| **NUnit** | –ú–æ—â–Ω—ã–π, –≥–∏–±–∫–∏–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã |
| **MSTest** | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ Visual Studio, –ø—Ä–æ—Å—Ç–æ–π –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ |

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
| –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|------------|
| **Moq** | Mocking framework, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª—è–º–±–¥–∞-–≤—ã—Ä–∞–∂–µ–Ω–∏—è |
| **NSubstitute** | –ü—Ä–æ—Å—Ç–æ–π –∏ —á–∏—Ç–∞–µ–º—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –º–æ–∫–æ–≤ |
| **FakeItEasy** | –£–¥–æ–±–µ–Ω –ø—Ä–∏ BDD-–ø–æ–¥—Ö–æ–¥–µ |
| **JustMock** | –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –ø–ª–∞—Ç–Ω—ã–π |
| **Microsoft Fakes** | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —à—É–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —á–∞—Å—Ç—å Visual Studio Enterprise |

---

## üìê –°—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤

| –ü–∞—Ç—Ç–µ—Ä–Ω | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| **AAA (Arrange-Act-Assert)** | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ‚Üí –¥–µ–π—Å—Ç–≤–∏–µ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ |
| **GWT (Given-When-Then)** | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ BDD, –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ |
| **SEVT (Setup-Exercise-Verify-TearDown)** | –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ |
| **CSE (Context/Specification)** | –î–ª—è BDD –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —è–∑—ã–∫–æ–≤ |
| **Method Pattern** | –ß—ë—Ç–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ –º–µ—Ç–æ–¥—É –∏ —Å—Ü–µ–Ω–∞—Ä–∏—é |

---

### –ü—Ä–∏–º–µ—Ä GWT (BDD):

> [!example] Gherkin-—Å—Ü–µ–Ω–∞—Ä–∏–π
```gherkin
Feature: Calculator
  In order to avoid mistakes
  As a user
  I want to use a calculator to add numbers

  Scenario: Add two numbers
    Given I have entered 50 into the calculator
    And I have entered 70 into the calculator
    When I press add
    Then the result should be 120
```

> [!example] –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ C# (SpecFlow)
```csharp
[Binding]
public class CalculatorSteps
{
    private Calculator _calculator = new();
    private int _result;

    [Given(@"I have entered (.*) into the calculator")]
    public void GivenIHaveEnteredNumber(int number)
    {
        _calculator.Enter(number);
    }

    [When(@"I press add")]
    public void WhenIPressAdd()
    {
        _result = _calculator.Add();
    }

    [Then(@"the result should be (.*)")]
    public void ThenTheResultShouldBe(int expected)
    {
        Assert.Equal(expected, _result);
    }
}
```

> [!warning] –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ BDD:
- –¢—Ä–µ–±—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —à–∞–≥–æ–≤ (`step definitions`)
- –ê–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –º–æ–∂–µ—Ç —Å–Ω–∏–∂–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## ü§ñ Mock vs Stub

| –¢–∏–ø | –¶–µ–ª—å | –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|-----|------|------------------|
| **Stub** | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ | `Setup(...).Returns(...)` –≤ Moq / `Returns(...)` –≤ NSubstitute |
| **Mock** | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞) | `Verify(...)` –≤ Moq / `Received()` –≤ NSubstitute |

---

## ‚úÖ –ü—Ä–∏–º–µ—Ä —é–Ω–∏—Ç-—Ç–µ—Å—Ç–∞ —Å Moq –∏ NSubstitute

–î–æ–ø—É—Å—Ç–∏–º, –µ—Å—Ç—å –∫–ª–∞—Å—Å `OrderService`, –∑–∞–≤–∏—Å—è—â–∏–π –æ—Ç `IInventoryService`.

```csharp
public interface IInventoryService
{
    bool IsInStock(int productId, int quantity);
    void ReserveItems(int productId, int quantity);
}

public class OrderService
{
    private readonly IInventoryService _inventory;

    public OrderService(IInventoryService inventory) => _inventory = inventory;

    public bool PlaceOrder(int productId, int quantity)
    {
        if (!_inventory.IsInStock(productId, quantity))
            return false;

        _inventory.ReserveItems(productId, quantity);
        return true;
    }
}
```

---

### > [!example] –¢–µ—Å—Ç —Å Moq

```csharp
[Fact]
public void PlaceOrder_WhenInStock_ReservesItems()
{
    // Arrange
    var mockInventory = new Mock<IInventoryService>();
    mockInventory.Setup(i => i.IsInStock(1, 2)).Returns(true);

    var service = new OrderService(mockInventory.Object);

    // Act
    var result = service.PlaceOrder(1, 2);

    // Assert
    Assert.True(result);
    mockInventory.Verify(i => i.ReserveItems(1, 2), Times.Once());
}
```

---

### > [!example] –¢–µ—Å—Ç —Å NSubstitute

```csharp
[Fact]
public void PlaceOrder_WhenInStock_ReservesItems()
{
    // Arrange
    var inventory = Substitute.For<IInventoryService>();
    inventory.IsInStock(1, 2).Returns(true);

    var service = new OrderService(inventory);

    // Act
    var result = service.PlaceOrder(1, 2);

    // Assert
    Assert.True(result);
    inventory.Received().ReserveItems(1, 2);
}
```

---

## ‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ Moq –∏ NSubstitute

| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å | Moq | NSubstitute |
|-------------|-----|--------------|
| –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–∫–∞ | `new Mock<IService>()` | `Substitute.For<IService>()` |
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏—è | `.Setup(x => x.Method()).Returns(value)` | `.Method().Returns(value)` |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑–æ–≤–∞ | `.Verify(x => x.Method(), Times.Once())` | `.Received().Method()` |
| –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å | –°–ª–æ–∂–Ω–µ–µ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ | –ë–æ–ª–µ–µ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω—è—Ç–µ–Ω |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ BDD | –•–æ—Ä–æ—à–∞—è | –û—Ç–ª–∏—á–Ω–∞—è, –æ—Å–æ–±–µ–Ω–Ω–æ —Å NSpec |

---

## üö® –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

> [!example]
```csharp
[Fact]
public void Divide_WhenDividedByZero_ThrowsException()
{
    // Arrange
    var calculator = new Calculator();

    // Act & Assert
    Assert.Throws<DivideByZeroException>(() => calculator.Divide(5, 0));
}
```

---

## üèóÔ∏è Builder Pattern –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤

–ü–æ–ª–µ–∑–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö.

```csharp
public class CustomerBuilder
{
    private string _name = "John Doe";
    private int _age = 30;

    public Customer Build() => new(_name, _age);

    public CustomerBuilder WithName(string name)
    {
        _name = name;
        return this;
    }

    public CustomerBuilder WithAge(int age)
    {
        _age = age;
        return this;
    }
}
```

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```csharp
var customer = new CustomerBuilder().WithName("Alice").WithAge(25).Build();
```

---

## ‚ùå –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

> [!danger] –ù–µ –¥–µ–ª–∞–π —Ç–∞–∫:
- **–ú–æ–∫–∞–µ—à—å –≤—Å—ë –ø–æ–¥—Ä—è–¥**, –¥–∞–∂–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã.
- **–ü—Ä–æ–≤–µ—Ä—è–µ—à—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**, –∞ –Ω–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.
- **–ò—Å–ø–æ–ª—å–∑—É–µ—à—å `Thread.Sleep()`**, —á—Ç–æ–±—ã –¥–∞—Ç—å –≤—Ä–µ–º—è —á–µ–º—É-—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è.
- **–ó–∞–≤–∏—Å–∏—à—å –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ (`DateTime.Now`)** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é `IClock`.
- **–¢–µ—Å—Ç–∏—Ä—É–µ—à—å DTO, Enum, Razor/XAML** ‚Äî —Ç–∞–º –Ω–µ—Ç –ª–æ–≥–∏–∫–∏.
- **–¢–µ—Å—Ç–∏—Ä—É–µ—à—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã** ‚Äî –≤—ã–Ω–æ—Å–∏ –≤ –ø—É–±–ª–∏—á–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã.

---

## üß© –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (Tabular tests)

### xUnit
> [!example]
```csharp
[Theory]
[InlineData(2, 3, 5)]
[InlineData(-1, 1, 0)]
public void Add_TwoNumbers_ReturnsSum(int a, int b, int expected)
{
    Assert.Equal(expected, a + b);
}
```

### NUnit
> [!example]
```csharp
[Test]
public void Add_TwoNumbers_ReturnsSum(
    [Values(2, -1)] int a, 
    [Values(3, 1)] int b,
    [Values(5, 0)] int expected)
{
    Assert.AreEqual(expected, a + b);
}
```

---

## üõ† –°–æ–≤–µ—Ç—ã –∏ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è

- **DTO: `record` vs `class`** ‚Äî –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –æ—Ç–¥–∞–≤–∞—Ç—å `record`, –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
- **–ò—Å–∫–ª—é—á–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å middleware –≤–º–µ—Å—Ç–æ try-catch.
- **Keyed Services** ‚Äî –º–æ–∂–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –æ–¥–Ω–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.
- **HATEOAS** ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Å—ã–ª–∫–∏ –≤ REST API, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
  - `Debug` ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  - `Info` ‚Äî –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  - `Error` ‚Äî –æ—à–∏–±–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

## üì¶ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º —Ç–µ—Å—Ç–∞

‚úÖ –ü–æ–≤—ã—Å–∏—Ç –ª–∏ —Ç–µ—Å—Ç –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è?  
‚úÖ –û–±–Ω–∞—Ä—É–∂–∏—Ç –ª–∏ –æ–Ω —Ä–µ–≥—Ä–µ—Å—Å–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏?  
‚úÖ –£–ø—Ä–æ—Å—Ç–∏—Ç –ª–∏ –æ—Ç–ª–∞–¥–∫—É?  

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [xUnit.net](https://xunit.net/)
- [Moq Quickstart](https://github.com/moq/moq4/wiki/Quickstart)
- [NSubstitute Docs](https://nsubstitute.github.io/)
- [FluentAssertions Docs](https://fluentassertions.com/)
- [SpecFlow](https://specflow.org/)
- [Coverlet](https://github.com/coverlet-coverage/coverlet)
- [TDD by Martin Fowler](https://martinfowler.com/bliki/TestDrivenDevelopment.html)
